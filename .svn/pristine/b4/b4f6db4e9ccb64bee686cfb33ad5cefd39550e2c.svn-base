using LateCat.PoseidonEngine.Abstractions;
using LateCat.PoseidonEngine.Core;
using System.IO;

namespace LateCat.Factory
{
    internal class PropertyFactory : IPropertyFactory
    {
        public string CreatePropertyFolder(IWallpaperMetadata metadata, IMonitor monitor, WallpaperArrangement arrangement)
        {
            string propertyPath = null;
            if (metadata.PropertyPath != null)
            {
                //customisable wallpaper, livelyproperty.json is present.
                var dataFolder = Path.Combine(Program.WallpaperDir, "SaveData", "wpdata");
                try
                {
                    //extract last digits of the Screen class DeviceName, eg: \\.\DISPLAY4 -> 4
                    var screenNumber = monitor.DeviceNumber;
                    if (screenNumber != null)
                    {
                        //Create a directory with the wp foldername in SaveData/wpdata/, copy livelyproperties.json into this.
                        //Further modifications are done to the copy file.
                        string wpdataFolder = null;
                        switch (arrangement)
                        {
                            case WallpaperArrangement.Per:
                                wpdataFolder = Path.Combine(dataFolder, new DirectoryInfo(metadata.InfoFolderPath).Name, screenNumber);
                                break;
                            case WallpaperArrangement.Span:
                                wpdataFolder = Path.Combine(dataFolder, new DirectoryInfo(metadata.InfoFolderPath).Name, "span");
                                break;
                            case WallpaperArrangement.Duplicate:
                                wpdataFolder = Path.Combine(dataFolder, new DirectoryInfo(metadata.InfoFolderPath).Name, "duplicate");
                                break;
                        }
                        Directory.CreateDirectory(wpdataFolder);
                        //copy the original file if not found..
                        propertyPath = Path.Combine(wpdataFolder, "LivelyProperties.json");
                        if (!File.Exists(propertyPath))
                        {
                            File.Copy(metadata.PropertyPath, propertyPath);
                        }
                    }
                    else
                    {
                        //todo: fallback, use the original file (restore feature disabled.)
                    }
                }
                catch
                {
                    //todo: fallback, use the original file (restore feature disabled.)
                }
            }
            return propertyPath;
        }
    }
}
